<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="python," />





  <link rel="alternate" href="/atom.xml" title="whistlestop" type="application/atom+xml" />






<meta name="description" content="Changing the String Representation of InstancesTo change the string representation of an instance, define the __str__() and __repr__() methods.">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="C08_Classes_and_Objects">
<meta property="og:url" content="blog.whistlestop.ml/2018/12/15/C08-Classes-and-Objects/index.html">
<meta property="og:site_name" content="whistlestop">
<meta property="og:description" content="Changing the String Representation of InstancesTo change the string representation of an instance, define the __str__() and __repr__() methods.">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-12-15T11:12:02.968Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C08_Classes_and_Objects">
<meta name="twitter:description" content="Changing the String Representation of InstancesTo change the string representation of an instance, define the __str__() and __repr__() methods.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="blog.whistlestop.ml/2018/12/15/C08-Classes-and-Objects/"/>





  <title>C08_Classes_and_Objects | whistlestop</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container  page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">whistlestop</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Never start something you're not willing to finish.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="blog.whistlestop.ml/2018/12/15/C08-Classes-and-Objects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eustoma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="whistlestop">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">C08_Classes_and_Objects</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-15T18:45:58+08:00">
                2018-12-15
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-12-15T19:12:02+08:00">
                2018-12-15
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/book-notes/" itemprop="url" rel="index">
                    <span itemprop="name">book notes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Changing-the-String-Representation-of-Instances"><a href="#Changing-the-String-Representation-of-Instances" class="headerlink" title="Changing the String Representation of Instances"></a>Changing the String Representation of Instances</h2><p>To change the string representation of an instance, define the <strong>__str__()</strong> and <strong>__repr__()</strong> methods.<br><a id="more"></a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Pair</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.x= x</span><br><span class="line"><span class="meta">... </span>        self.y =y</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="string">'Pair(&#123;0.x!r&#125;, &#123;0.y!r&#125;)'</span>.format(self)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="string">'(&#123;0.x!s&#125;, &#123;0.y!s&#125;)'</span>.format(self)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p= Pair(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p</span><br><span class="line">Pair(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(p)</span><br><span class="line">(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'p is &#123;0!r&#125;'</span>.format(p))</span><br><span class="line">p <span class="keyword">is</span> Pair(<span class="number">3</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure></p>
<p>Specifically, the special <strong>!r</strong> formatting code indicates that the output of  <strong>__repr__()</strong> should be used instead of <strong>__str__()</strong>.</p>
<p>The use of format() in the solution might look a little funny, but the format code <strong>{0.x}</strong> specifies the x-attribute of argument 0.</p>
<h2 id="Customizing-String-Formatting"><a href="#Customizing-String-Formatting" class="headerlink" title="Customizing String Formatting"></a>Customizing String Formatting</h2><p>To customize string formatting, define the <strong>__format__()</strong> method on a class. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>_formats = &#123;</span><br><span class="line"><span class="meta">... </span> <span class="string">'ymd'</span> : <span class="string">'&#123;d.year&#125;-&#123;d.month&#125;-&#123;d.day&#125;'</span>,</span><br><span class="line"><span class="meta">... </span> <span class="string">'mdy'</span> : <span class="string">'&#123;d.month&#125;/&#123;d.day&#125;/&#123;d.year&#125;'</span>,</span><br><span class="line"><span class="meta">... </span> <span class="string">'dmy'</span> : <span class="string">'&#123;d.day&#125;/&#123;d.month&#125;/&#123;d.year&#125;'</span></span><br><span class="line"><span class="meta">... </span> &#125;</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.year= year</span><br><span class="line"><span class="meta">... </span>        self.month= month</span><br><span class="line"><span class="meta">... </span>        self.day= day</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__format__</span><span class="params">(self,code)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> code == <span class="string">''</span>:</span><br><span class="line"><span class="meta">... </span>            code= <span class="string">'ymd'</span></span><br><span class="line"><span class="meta">... </span>        fmt= _formats[code]</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> fmt.format(d= self)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Instances of the <strong>Date</strong> class now support formatting operations such as the following:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d= Date(<span class="number">2012</span>,<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(d)</span><br><span class="line"><span class="string">'2012-3-5'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(d,<span class="string">'mdy'</span>)</span><br><span class="line"><span class="string">'3/5/2012'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'The date is &#123;:ymd&#125;'</span>.format(d)</span><br><span class="line"><span class="string">'The date is 2012-3-5'</span></span><br></pre></td></tr></table></figure>
<p>The <strong>__format__()</strong> method provides a hook into Python’s string formatting functionality. It’s important to emphasize that the interpretation of format codes is entirely up to the class itself. Thus, the codes can be almost anything at all. </p>
<h2 id="Making-Objects-Support-the-Context-Management-Protocol"><a href="#Making-Objects-Support-the-Context-Management-Protocol" class="headerlink" title="Making Objects Support the Context-Management Protocol"></a>Making Objects Support the Context-Management Protocol</h2><p>In order to make an object compatible with the with statement, you need to implement <strong>__enter__()</strong> and <strong>__exit__()</strong> methods</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socket, AF_INET, SOCK_STREAM</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">LazyConnection</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address, family= AF_INET, type= SOCK_STREAM)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.address= address</span><br><span class="line"><span class="meta">... </span>        self.family= AF_INET</span><br><span class="line"><span class="meta">... </span>        self.type= SOCK_STREAM</span><br><span class="line"><span class="meta">... </span>        self.sock= <span class="keyword">None</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> self.sock <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> RuntimeError(<span class="string">'Already connected'</span>)</span><br><span class="line"><span class="meta">... </span>        self.sock= socket(self.family, self.type)</span><br><span class="line"><span class="meta">... </span>        self.sock.connect(self.address)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.sock</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_ty, exc_val, tb)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.sock.close()</span><br><span class="line"><span class="meta">... </span>        self.sock= <span class="keyword">None</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The key feature of this class is that it represents a network connection, but it doesn’t actually do anything initially (e.g., it doesn’t establish a connection). Instead, the connection is established and closed using the <strong>with</strong> statement.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cnn= LazyConnection((<span class="string">'www.python.org'</span>, <span class="number">80</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> cnn <span class="keyword">as</span> s:</span><br><span class="line"><span class="meta">... </span>    s.send(<span class="string">b'GET /index.html HTTP/1.0\r\n'</span>)</span><br><span class="line"><span class="meta">... </span>    s.send(<span class="string">b'\r\n'</span>)</span><br><span class="line"><span class="meta">... </span>    resp = <span class="string">b''</span>.join(iter(partial(s.recv, <span class="number">8192</span>), <span class="string">b''</span>))</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="number">26</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>In fact, the three arguments to the <strong>__exit__()</strong> method contain the exception type, value, and traceback for pending exceptions (if any). The <strong>__exit__()</strong> method can choose to use the exception information in some way or to ignore it by doing nothing and returning <strong>None</strong> as a result. If <strong>__exit__()</strong> returns <strong>True</strong>, the exception is cleared as if nothing happened and the program continues executing statements immediately after the with block.</p>
<p>One subtle aspect of this recipe is whether or not the <strong>LazyConnection</strong> class allows nested use of the connection with multiple with statements. You can work around this limitation with a slightly different implementation, as shown here:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">LazyConnection</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address, family= AF_INET, type= SOCK_STREAM)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.address= address</span><br><span class="line"><span class="meta">... </span>        self.family= AF_INET</span><br><span class="line"><span class="meta">... </span>        self.type= SOCK_STREAM</span><br><span class="line"><span class="meta">... </span>        self.connections= []</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        sock= socket(self.family, self.type)</span><br><span class="line"><span class="meta">... </span>        sock.connect(self.address)</span><br><span class="line"><span class="meta">... </span>        self.connections.append(sock)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> sock</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_ty, exc_val, tb)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.connections.pop().close()</span><br><span class="line"><span class="meta">... </span>        </span><br><span class="line"><span class="meta">... </span></span><br><span class="line">conn = LazyConnection((<span class="string">'www.python.org'</span>, <span class="number">80</span>))</span><br><span class="line"><span class="keyword">with</span> conn <span class="keyword">as</span> s1:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">with</span> conn <span class="keyword">as</span> s2:</span><br><span class="line">        ...</span><br><span class="line">         <span class="comment"># s1 and s2 are independent sockets</span></span><br></pre></td></tr></table></figure>
<h2 id="Saving-Memory-When-Creating-a-Large-Number-of-Instances"><a href="#Saving-Memory-When-Creating-a-Large-Number-of-Instances" class="headerlink" title="Saving Memory When Creating a Large Number of Instances"></a>Saving Memory When Creating a Large Number of Instances</h2><p>For classes that primarily serve as simple data structures, you can often greatly reduce the memory footprint of instances by adding the <strong>__slots__</strong> attribute to the class definition.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; <span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line"><span class="meta">... </span>    __slots__=[<span class="string">'year'</span>, <span class="string">'month'</span>,<span class="string">'day'</span>]</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.year= year</span><br><span class="line"><span class="meta">... </span>        self.month= month</span><br><span class="line"><span class="meta">... </span>        self.day= day</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d=Date(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&lt;__main__.Date object at <span class="number">0x010C0D50</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.exp=<span class="number">4</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'Date'</span> object has no attribute <span class="string">'exp'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.__dict__</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'Date'</span> object has no attribute <span class="string">'__dict__'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>vars(d)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: vars() argument must have __dict__ attribute</span><br></pre></td></tr></table></figure>
<p> A side effect of using slots is that it is no longer possible to add new attributes to instances—you are restricted to only those attribute names listed in the <strong>__slots__</strong> specifier.</p>
<h2 id="Encapsulating-Names-in-a-Class"><a href="#Encapsulating-Names-in-a-Class" class="headerlink" title="Encapsulating Names in a Class"></a>Encapsulating Names in a Class</h2><p>Rather than relying on language features to encapsulate data, Python programmers are expected to observe certain naming conventions concerning the intended usage of data and methods. The first convention is that any name that starts with a single leading underscore (<strong>_</strong>) should always be assumed to be internal implementation.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._internal = <span class="number">0</span> <span class="comment"># An internal attribute</span></span><br><span class="line">        self.public = <span class="number">1</span> <span class="comment"># A public attribute</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        A public method</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">         ...</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">_internal_method</span><span class="params">(self)</span>:</span></span><br><span class="line">         ...</span><br></pre></td></tr></table></figure>
<p>Python doesn’t actually prevent someone from accessing internal names. However, doing so is considered impolite, and may result in fragile code. It should be noted, too, that the use of the leading underscore is also used for module names and module-level functions. For example, if you ever see a module name that starts with a leading underscore (e.g., <strong>_socket</strong>), it’s internal implementation. </p>
<p>You may also encounter the use of two leading underscores (<strong>__</strong>) on names within class definitions. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__private = <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__private_method</span><span class="params">(self)</span>:</span></span><br><span class="line">         ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        self.__private_method()</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>The use of double leading underscores causes the name to be mangled to something else. Specifically, the private attributes in the preceding class get renamed to <strong>_B__private</strong> and <strong>_B__private_method</strong>, respectively. At this point, you might ask what purpose such name mangling serves. The answer is inheritance—such attributes cannot be overridden via inheritance.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.__private = <span class="number">1</span> <span class="comment"># Does not override B.__private</span></span><br><span class="line">    <span class="comment"># Does not override B.__private_method()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__private_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<p>Here, the private names <strong>__private</strong> and <strong>__private_method</strong> get renamed to <strong>_C__private</strong> and <strong>_C__private_method</strong>, which are different than the mangled names in the base class <strong>B</strong>.</p>
<h2 id="Creating-Managed-Attributes"><a href="#Creating-Managed-Attributes" class="headerlink" title="Creating Managed Attributes"></a>Creating Managed Attributes</h2><p>A simple way to customize access to an attribute is to define it as a “property.” </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, first_name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.first_name= first_name</span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._first_name</span><br><span class="line"><span class="meta">... </span>    @first_name.setter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self,value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line"><span class="meta">... </span>        self._first_name= value</span><br><span class="line"><span class="meta">... </span>    @first_name.deleter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> AttributeError(<span class="string">'Can not delete attribute'</span>)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Person(<span class="string">'Guido'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.first_name</span><br><span class="line"><span class="string">'Guido'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.first_name=<span class="number">42</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">10</span>, <span class="keyword">in</span> first_name</span><br><span class="line">TypeError: Expected a string</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a.first_name</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">14</span>, <span class="keyword">in</span> first_name</span><br><span class="line">AttributeError: Can <span class="keyword">not</span> delete attribute</span><br></pre></td></tr></table></figure>
<p>When implementing a property, the underlying data (if any) still needs to be stored somewhere. Thus, in the get and set methods, you see direct manipulation of a <strong>_first_name</strong> attribute, which is where the actual data lives. In addition, you may ask why the <strong>__init__()</strong> method sets <strong>self.first_name</strong> instead of <strong>self._first_name</strong>. In this example, the entire point of the property is to apply type checking when setting an attribute. Thus, chances are you would also want such checking to take place during initialization. By setting <strong>self.first_name</strong>, the set operation uses the setter method (as opposed to bypassing it by accessing <strong>self._first_name</strong>).</p>
<p>A property attribute is actually a collection of methods bundled together. If you inspect a class with a property, you can find the raw methods in the <strong>fget</strong>, <strong>fset</strong>, and <strong>fdel</strong> attributes of the property itself. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Person.first_name.fget</span><br><span class="line">&lt;function Person.first_name at <span class="number">0x1006a60e0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Person.first_name.fset</span><br><span class="line">&lt;function Person.first_name at <span class="number">0x1006a6170</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Person.first_name.fdel</span><br><span class="line">&lt;function Person.first_name at <span class="number">0x1006a62e0</span>&gt;</span><br></pre></td></tr></table></figure>
<p>Properties can also be a way to define computed attributes. These are attributes that are not actually stored, but computed on demand. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> math</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, radius)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.radius= radius</span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> math.pi * self.radius ** <span class="number">2</span></span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">perimeter</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="number">2</span> * math.pi * self.radius</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c= Circle(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.radius</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">28.274333882308138</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area= <span class="number">4</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: can<span class="string">'t set attribute</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>Don’t write Python code that features a lot of repetitive property definitions. For example:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, first_name, last_name)</span>:</span></span><br><span class="line">        self.first_name = first_name</span><br><span class="line">        self.last_name = last_name</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._first_name</span><br><span class="line"><span class="meta">    @first_name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._first_name = value</span><br><span class="line">    <span class="comment"># Repeated property code, but for a different name (bad!)</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">last_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._last_name</span><br><span class="line"><span class="meta">    @last_name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">last_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._last_name = value</span><br></pre></td></tr></table></figure></p>
<p>Code repetition leads to bloated, error prone, and ugly code. As it turns out, there are much better ways to achieve the same thing using descriptors or closures. </p>
<h2 id="Calling-a-Method-on-a-Parent-Class"><a href="#Calling-a-Method-on-a-Parent-Class" class="headerlink" title="Calling a Method on a Parent Class"></a>Calling a Method on a Parent Class</h2><p>To call a method in a parent (or superclass), use the super() function. A very common use of <strong>super()</strong> is in the handling of the <strong>__init__()</strong> method to make sure that parents are properly initialized:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.x = <span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.y = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>Another common use of <strong>super()</strong> is in code that overrides any of Python’s special methods. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Proxy</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        self._obj = obj</span><br><span class="line">    <span class="comment"># Delegate attribute lookup to internal obj</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._obj, name)</span><br><span class="line">    <span class="comment"># Delegate attribute assignment</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            super().__setattr__(name, value) <span class="comment"># Call original __setattr__</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            setattr(self._obj, name, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Base.__init__'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        print(<span class="string">'A.__init__'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        print(<span class="string">'B.__init__'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A,B)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__() <span class="comment"># Only one call to super() here</span></span><br><span class="line">        print(<span class="string">'C.__init__'</span>)</span><br></pre></td></tr></table></figure>
<p>You’ll find that each <strong>__init__()</strong> method only gets called once:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = C()</span><br><span class="line">Base.__init__</span><br><span class="line">B.__init__</span><br><span class="line">A.__init__</span><br><span class="line">C.__init__</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>For every class that you define, Python computes what’s known as a method resolution order (MRO) list. The MRO list is simply a linear ordering of all the base classes. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>C.__mro__</span><br><span class="line">(&lt;class '__main__.C'&gt;, &lt;class '__main__.A'&gt;, &lt;class '__main__.B'&gt;,</span><br><span class="line">&lt;class '__main__.Base'&gt;, &lt;class 'object'&gt;)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>When you use the <strong>super()</strong> function, Python continues its search starting with the next class on the MRO. As long as every redefined method consistently uses <strong>super()</strong> and only calls it once, control will ultimately work its way through the entire MRO list and each method will only be called once. </p>
<p>A somewhat surprising aspect of <strong>super()</strong> is that it doesn’t necessarily go to the direct parent of a class next in the MRO and that you can even use it in a class with no direct parent at all. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>)</span><br><span class="line">        super().spam()</span><br></pre></td></tr></table></figure>
<p>If you try to use this class, you’ll find that it’s completely broken:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = A()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.spam()</span><br><span class="line">A.spam</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">4</span>, <span class="keyword">in</span> spam</span><br><span class="line">AttributeError: <span class="string">'super'</span> object has no attribute <span class="string">'spam'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Watch what happens if you start using the class with multiple inheritance:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'B.spam'</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A,B)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = C()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.spam()</span><br><span class="line">A.spam</span><br><span class="line">B.spam</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Here you see that the use of <strong>super().spam()</strong> in class A has, in fact, called the <strong>spam()</strong> method in class <strong>B</strong>—a class that is completely unrelated to <strong>A</strong>! This is all explained by the MRO of class <strong>C</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>C.__mro__</span><br><span class="line">(&lt;class '__main__.C'&gt;, &lt;class '__main__.A'&gt;, &lt;class '__main__.B'&gt;,</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">object</span>'&gt;)</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Extending-a-Property-in-a-Subclass"><a href="#Extending-a-Property-in-a-Subclass" class="headerlink" title="Extending a Property in a Subclass"></a>Extending a Property in a Subclass</h2><p>Within a subclass, you want to extend the functionality of a property defined in a parent class.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._name</span><br><span class="line"><span class="meta">... </span>    @name.setter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line"><span class="meta">... </span>        self._name = value</span><br><span class="line"><span class="meta">... </span>    @name.deleter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> AttributeError(<span class="string">'Can not delete attribute'</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here is an example of a class that inherits from <strong>Person</strong> and extends the <strong>name</strong> property with new functionality.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SubPerson</span><span class="params">(Person)</span>:</span></span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Getting name'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().name</span><br><span class="line"><span class="meta">... </span>    @name.setter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Setting name to '</span>, value)</span><br><span class="line"><span class="meta">... </span>        super(SubPerson, SubPerson).name.__set__(self, value)</span><br><span class="line"><span class="meta">... </span>    @name.deleter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Deleting name'</span>)</span><br><span class="line"><span class="meta">... </span>        super(SubPerson, SubPerson).name.__delete__(self)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here is an example of the new class in use:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = SubPerson(<span class="string">'Guido'</span>)</span><br><span class="line">Setting name to Guido</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name</span><br><span class="line">Getting name</span><br><span class="line"><span class="string">'Guido'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name = <span class="string">'Larry'</span></span><br><span class="line">Setting name to Larry</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name = <span class="number">42</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">16</span>, <span class="keyword">in</span> name</span><br><span class="line"> <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">TypeError: Expected a string</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p> The use of <strong>super(SubPerson, SubPerson).name.__set__(self, value)</strong> in the setter function is no mistake. To delegate to the previous implementation of the setter, control needs to pass through the <strong>__set__()</strong> method of the previously defined name property. However, the only way to get to this method is to access it as a class variable instead of an instance variable. This is what happens with the <strong>super(SubPerson, SubPerson)</strong> operation.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SubPerson</span><span class="params">(Person)</span>:</span></span><br><span class="line"><span class="meta">... </span>    @Person.name.getter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Getting name'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().name</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>When you do this, all of the previously defined methods of the property are copied, and the getter function is replaced. It now works as expected:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = SubPerson(<span class="string">'Guido'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name</span><br><span class="line">Getting name</span><br><span class="line"><span class="string">'Guido'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name = <span class="string">'Larry'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name</span><br><span class="line">Getting name</span><br><span class="line"><span class="string">'Larry'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name = <span class="number">42</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">16</span>, <span class="keyword">in</span> name</span><br><span class="line"> <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">TypeError: Expected a string</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>It’s worth noting that the first technique shown in this recipe can also be used to extend a descriptor.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">String</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> self</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line"><span class="meta">... </span>        instance.__dict__[self.name]= value</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line"><span class="meta">... </span>    name= String(<span class="string">'name'</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SubPerson</span><span class="params">(Person)</span>:</span></span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Getting name'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().name</span><br><span class="line"><span class="meta">... </span>    @name.setter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Setting name to'</span>, value)</span><br><span class="line"><span class="meta">... </span>        super(SubPerson, SubPerson).name.__set__(self, value)</span><br><span class="line"><span class="meta">... </span>    @name.deleter</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Deleting name'</span>)</span><br><span class="line"><span class="meta">... </span>        super(SubPerson, SubPerson).name.__delete__(self)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s= SubPerson(<span class="string">'gu'</span>)</span><br><span class="line">Setting name to gu</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name=<span class="string">'rr'</span></span><br><span class="line">Setting name to rr</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Creating-a-New-Kind-of-Class-or-Instance-Attribute"><a href="#Creating-a-New-Kind-of-Class-or-Instance-Attribute" class="headerlink" title="Creating a New Kind of Class or Instance Attribute"></a>Creating a New Kind of Class or Instance Attribute</h2><p>If you want to create an entirely new kind of instance attribute, define its functionality in the form of a descriptor class. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Descriptor attribute for an integer type-checked attribute</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Integer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, int):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected an int'</span>)</span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delete__</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> instance.__dict__[self.name]</span><br></pre></td></tr></table></figure>
<p>A descriptor is a class that implements the three core attribute access operations (<strong>get</strong>, <strong>set</strong>, and <strong>delete</strong>) in the form of <strong>__get__()</strong>, <strong>__set__()</strong>, and <strong>__delete__()</strong> special methods. These methods work by receiving an instance as input. The underlying dictionary of the instance is then manipulated as appropriate.</p>
<p>To use a descriptor, instances of the descriptor are placed into a class definition as class variables. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    x = Integer(<span class="string">'x'</span>)</span><br><span class="line">    y = Integer(<span class="string">'y'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Point(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.x <span class="comment"># Calls Point.x.__get__(p,Point)</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.y = <span class="number">5</span> <span class="comment"># Calls Point.y.__set__(p, 5)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.x = <span class="number">2.3</span> <span class="comment"># Calls Point.x.__set__(p, 2.3)</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"descrip.py"</span>, line <span class="number">12</span>, <span class="keyword">in</span> __set__</span><br><span class="line"> <span class="keyword">raise</span> TypeError(<span class="string">'Expected an int'</span>)</span><br><span class="line">TypeError: Expected an int</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>As input, each method of a descriptor receives the instance being manipulated. To carry out the requested operation, the underlying instance dictionary (the <strong>__dict__</strong> attribute) is manipulated as appropriate. The <strong>self.name</strong> attribute of the descriptor holds the dictionary key being used to store the actual data in the instance dictionary.</p>
<p>The implementation of the <strong>__get__()</strong> method is trickier than it seems:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Descriptor attribute for an integer type-checked attribute</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Integer</span>:</span></span><br><span class="line">    ...</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">         <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">             <span class="keyword">return</span> self</span><br><span class="line">         <span class="keyword">else</span>:</span><br><span class="line">             <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<p>The reason <strong>__get__()</strong> looks somewhat complicated is to account for the distinction between instance variables and class variables. If a descriptor is accessed as a class variable, the instance argument is set to None. In this case, it is standard practice to simply return the descriptor instance itself.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, expected_type)</span>:</span></span><br><span class="line">        self.name= name</span><br><span class="line">        self.expected_type= expected_type</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.expected_type):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected '</span>+ str(self.expected_type))</span><br><span class="line">        instance.__dict__[self.name]= value</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">typeassert</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorate</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> name, expected_type <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            setattr(cls, name, Typed(name, expected_type))</span><br><span class="line">        <span class="keyword">return</span> cls</span><br><span class="line">    <span class="keyword">return</span> decorate</span><br><span class="line"><span class="meta">@typeassert(name= str, shares= int, price= float)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, shares, price)</span>:</span></span><br><span class="line">        self.name= name</span><br><span class="line">        self.shares= shares</span><br><span class="line">        self.price= price</span><br></pre></td></tr></table></figure>
<p>Finally, it should be stressed that you would probably not write a descriptor if you simply want to customize the access of a single attribute of a specific class. For that, it’s easier to use a property instead. Descriptors are more useful in situations where there will be a lot of code reuse.</p>
<h2 id="Using-Lazily-Computed-Properties"><a href="#Using-Lazily-Computed-Properties" class="headerlink" title="Using Lazily Computed Properties"></a>Using Lazily Computed Properties</h2><p>You’d like to define a read-only attribute as a property that only gets computed on access. However, once accessed, you’d like the value to be cached and not recomputed on each access.</p>
<p>An efficient way to define a lazy attribute is through the use of a descriptor class.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">lazyproperty</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.func= func</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> self</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>            value= self.func(instance)</span><br><span class="line"><span class="meta">... </span>            setattr(instance, self.func.__name__, value)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> value</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>To utilize this code, you would use it in a class such as the following:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> math</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, radius)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.radius= radius</span><br><span class="line"><span class="meta">... </span>    @lazyproperty</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Computing area'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> math.pi * self.radius ** <span class="number">2</span></span><br><span class="line"><span class="meta">... </span>    @lazyproperty</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">perimeter</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Computing perimeter'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="number">2</span> * math.pi * self.radius</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>An interactive session that illustrates how it works:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Circle(<span class="number">4.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.radius</span><br><span class="line"><span class="number">4.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line">Computing area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.perimeter</span><br><span class="line">Computing perimeter</span><br><span class="line"><span class="number">25.132741228718345</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.perimeter</span><br><span class="line"><span class="number">25.132741228718345</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>When a descriptor is placed into a class definition, its <strong>__get__()</strong>, <strong>__set__()</strong>, and <strong>__delete__()</strong> methods get triggered on attribute access. However, if a descriptor only defines a <strong>__get__()</strong> method, it has a much weaker binding than usual. In particular, the<strong>__get__()</strong> method only fires if the attribute being accessed is not in the underlying instance dictionary.</p>
<p>One possible downside to this recipe is that the computed value becomes mutable after it’s created. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line">Computing area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area = <span class="number">25</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">25</span></span><br></pre></td></tr></table></figure>
<p>You can use a slightly less efficient implementation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">lazyproperty</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">... </span>    name= <span class="string">'_lazy_'</span>+ func.__name__</span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">lazy</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> hasattr(self, name):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> getattr(self, name)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>            value= func(self)</span><br><span class="line"><span class="meta">... </span>            setattr(self, name, value)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> value</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> lazy</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c= Circle(<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line">Computing area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c._lazy_area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c._lazy_area= <span class="number">25</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">25</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area=<span class="number">45</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: can<span class="string">'t set attribute</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Simplifying-the-Initialization-of-Data-Structures"><a href="#Simplifying-the-Initialization-of-Data-Structures" class="headerlink" title="Simplifying the Initialization of Data Structures"></a>Simplifying the Initialization of Data Structures</h2><p>You can often generalize the initialization of data structures into a single <strong>__init__()</strong> function defined in a common base class.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Structure</span>:</span></span><br><span class="line"><span class="meta">... </span>    _fields= []</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> len(args) != len(self._fields):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'Expected &#123;&#125; arguments'</span>.format(len(self._fields)))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> name, value <span class="keyword">in</span> zip(self._fields, args):</span><br><span class="line"><span class="meta">... </span>            setattr(self, name, value)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Stock</span><span class="params">(Structure)</span>:</span></span><br><span class="line"><span class="meta">... </span>    _fields= [<span class="string">'name'</span>, <span class="string">'shares'</span>, <span class="string">'price'</span>]</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Points</span><span class="params">(Structure)</span>:</span></span><br><span class="line"><span class="meta">... </span>    _fields= [<span class="string">'x'</span>, <span class="string">'y'</span>]</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Circle</span><span class="params">(Structure)</span>:</span></span><br><span class="line"><span class="meta">... </span>    _fields=[<span class="string">'radius'</span>]</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> math.pi * self.radius ** <span class="number">2</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s= Stock(<span class="string">'Acme'</span>, <span class="number">80</span>, <span class="number">90</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c=Circle(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area()</span><br><span class="line"><span class="number">28.274333882308138</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s= Stock(<span class="string">'Acme'</span>, <span class="number">80</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">5</span>, <span class="keyword">in</span> __init__</span><br><span class="line">TypeError: Expected <span class="number">3</span> arguments</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>This technique of defining a general purpose <strong>__init__()</strong> method can be extremely useful if you’re ever writing a program built around a large number of small data structures.</p>
<p>One subtle aspect of the implementation concerns the mechanism used to set value using the <strong>setattr()</strong> function. Instead of doing that, you might be inclined to directly access the instance dictionary. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Structure</span>:</span></span><br><span class="line">     <span class="comment"># Class variable that specifies expected fields</span></span><br><span class="line">    _fields= []</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">         <span class="keyword">if</span> len(args) != len(self._fields):</span><br><span class="line">             <span class="keyword">raise</span> TypeError(<span class="string">'Expected &#123;&#125; arguments'</span>.format(len(self._fields)))</span><br><span class="line">         <span class="comment"># Set the arguments (alternate)</span></span><br><span class="line">         self.__dict__.update(zip(self._fields,args))</span><br></pre></td></tr></table></figure>
<p>Although this works, it’s often not safe to make assumptions about the implementation of a subclass. If a subclass decided to use <strong>__slots__</strong> or wrap a specific attribute with a property (or descriptor), directly acccessing the instance dictionary would break. </p>
<p>It should be noted that it is also possible to automatically initialize instance variables using a utility function and a so-called “frame hack.”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">init_fromlocals</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">... </span>    locs= sys._getframe(<span class="number">1</span>).f_locals</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">for</span> k, v <span class="keyword">in</span> locs.items():</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> k != <span class="string">'self'</span>:</span><br><span class="line"><span class="meta">... </span>            setattr(self, k, v)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Stock</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, shares, price)</span>:</span></span><br><span class="line"><span class="meta">... </span>        init_fromlocals(self)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>In this variation, the <strong>init_fromlocals()</strong> function uses <strong>sys._getframe()</strong> to peek at the local variables of the calling method. If used as the first step of an <strong>__init__()</strong> method, the local variables will be the same as the passed arguments and can be easily used to set attributes with the same names. Although this approach avoids the problem of getting the right calling signature in IDEs, it runs more than 50% slower than the solution provided in the recipe, requires more typing, and involves more sophisticated magic behind the scenes.</p>
<h2 id="Defining-an-Interface-or-Abstract-Base-Class"><a href="#Defining-an-Interface-or-Abstract-Base-Class" class="headerlink" title="Defining an Interface or Abstract Base Class"></a>Defining an Interface or Abstract Base Class</h2><p>You want to define a class that serves as an interface or abstract base class from which you can perform type checking and ensure that certain methods are implemented in subclasses.</p>
<p>To define an abstract base class, use the abc module. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">IStream</span><span class="params">(metaclass= ABCMeta)</span>:</span></span><br><span class="line"><span class="meta">... </span>    @abstractmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, maxbytes= <span class="number">-1</span>)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span>    @abstractmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a=IStream()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: Can<span class="string">'t instantiate abstract class IStream with abstract methods read, write</span></span><br></pre></td></tr></table></figure>
<p>ABCs allow other classes to be registered as implementing the required interface. For example, you can do this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="comment"># Register the built-in I/O classes as supporting our interface</span></span><br><span class="line">IStream.register(io.IOBase)</span><br><span class="line"><span class="comment"># Open a normal file and type check</span></span><br><span class="line">f = open(<span class="string">'foo.txt'</span>)</span><br><span class="line">isinstance(f, IStream) <span class="comment"># Returns True</span></span><br></pre></td></tr></table></figure>
<p>It should be noted that <strong>@abstractmethod</strong> can also be applied to static methods, class methods, and properties. You just need to make sure you apply it in the proper sequence where <strong>@abstractmethod</strong> appears immediately before the function definition.</p>
<p>Predefined abstract base classes are found in various places in the standard library. The <strong>collections</strong> module defines a variety of ABCs related to containers and iterators (sequences, mappings, sets, etc.), the <strong>numbers</strong> library defines ABCs related to numeric objects (integers, floats, rationals, etc.), and the <strong>io</strong> library defines ABCs related to I/O handling.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="comment"># Check if x is a sequence</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Sequence):</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># Check if x is iterable</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Iterable):</span><br><span class="line">     ...</span><br><span class="line"><span class="comment"># Check if x has a size</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Sized):</span><br><span class="line">     ...</span><br><span class="line"><span class="comment"># Check if x is a mapping</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Mapping):</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure></p>
<p>It should be noted that, as of this writing, certain library modules don’t make use of these predefined ABCs as you might expect. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line">x = Decimal(<span class="string">'3.4'</span>)</span><br><span class="line">isinstance(x, numbers.Real) <span class="comment"># Returns False</span></span><br></pre></td></tr></table></figure>
<h2 id="Implementing-a-Data-Model-or-Type-System"><a href="#Implementing-a-Data-Model-or-Type-System" class="headerlink" title="Implementing a Data Model or Type System"></a>Implementing a Data Model or Type System</h2><p>You want to define various kinds of data structures, but want to enforce constraints on the values that are allowed to be assigned to certain attributes.</p>
<p>The following code illustrates the use of descriptors to implement a system type and value checking framework:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Base class. Uses a descriptor to set a value</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Descriptor</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, **opts)</span>:</span></span><br><span class="line">         self.name = name</span><br><span class="line">         <span class="keyword">for</span> key, value <span class="keyword">in</span> opts.items():</span><br><span class="line">             setattr(self, key, value)</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">         instance.__dict__[self.name] = value</span><br><span class="line"><span class="comment"># Descriptor for enforcing types</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typed</span><span class="params">(Descriptor)</span>:</span></span><br><span class="line">     expected_type = type(<span class="keyword">None</span>)</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, self.expected_type):</span><br><span class="line">             <span class="keyword">raise</span> TypeError(<span class="string">'expected '</span> + str(self.expected_type))</span><br><span class="line">         super().__set__(instance, value)</span><br><span class="line"><span class="comment"># Descriptor for enforcing values</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Unsigned</span><span class="params">(Descriptor)</span>:</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">         <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">             <span class="keyword">raise</span> ValueError(<span class="string">'Expected &gt;= 0'</span>)</span><br><span class="line">         super().__set__(instance, value)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaxSized</span><span class="params">(Descriptor)</span>:</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, **opts)</span>:</span></span><br><span class="line">         <span class="keyword">if</span> <span class="string">'size'</span> <span class="keyword">not</span> <span class="keyword">in</span> opts:</span><br><span class="line">             <span class="keyword">raise</span> TypeError(<span class="string">'missing size option'</span>)</span><br><span class="line">         super().__init__(name, **opts)</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">         <span class="keyword">if</span> len(value) &gt;= self.size:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'size must be &lt; '</span> + str(self.size))</span><br><span class="line">         super().__set__(instance, value)</span><br></pre></td></tr></table></figure>
<p>These classes should be viewed as basic building blocks from which you construct a data model or type system. Continuing, here is some code that implements some different kinds of data:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Integer</span><span class="params">(Typed)</span>:</span></span><br><span class="line">    expected_type = int</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsignedInteger</span><span class="params">(Integer, Unsigned)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Float</span><span class="params">(Typed)</span>:</span></span><br><span class="line">    expected_type = float</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsignedFloat</span><span class="params">(Float, Unsigned)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span><span class="params">(Typed)</span>:</span></span><br><span class="line">    expected_type = str</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SizedString</span><span class="params">(String, MaxSized)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>Using these type objects, it is now possible to define a class such as this: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span>:</span></span><br><span class="line"> <span class="comment"># Specify constraints</span></span><br><span class="line">    name = SizedString(<span class="string">'name'</span>,size=<span class="number">8</span>)</span><br><span class="line">    shares = UnsignedInteger(<span class="string">'shares'</span>)</span><br><span class="line">    price = UnsignedFloat(<span class="string">'price'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, shares, price)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.shares = shares</span><br><span class="line">        self.price = price</span><br></pre></td></tr></table></figure>
<p>With the constraints in place, you’ll find that assigning of attributes is now validated. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name</span><br><span class="line"><span class="string">'ACME'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.shares = <span class="number">75</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.shares = <span class="number">-10</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">17</span>, <span class="keyword">in</span> __set__</span><br><span class="line"> super().__set__(instance, value)</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">23</span>, <span class="keyword">in</span> __set__</span><br><span class="line"> <span class="keyword">raise</span> ValueError(<span class="string">'Expected &gt;= 0'</span>)</span><br><span class="line">ValueError: Expected &gt;= <span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.price = <span class="string">'a lot'</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">16</span>, <span class="keyword">in</span> __set__</span><br><span class="line"> <span class="keyword">raise</span> TypeError(<span class="string">'expected '</span> + str(self.expected_type))</span><br><span class="line">TypeError: expected &lt;<span class="class"><span class="keyword">class</span> '<span class="title">float</span>'&gt;</span></span><br><span class="line">&gt;&gt;&gt; s.name = 'ABRACADABRA'</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">17</span>, <span class="keyword">in</span> __set__</span><br><span class="line"> super().__set__(instance, value)</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">35</span>, <span class="keyword">in</span> __set__</span><br><span class="line"> <span class="keyword">raise</span> ValueError(<span class="string">'size must be &lt; '</span> + str(self.size))</span><br><span class="line">ValueError: size must be &lt; <span class="number">8</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>There are some techniques that can be used to simplify the specification of constraints in classes. One approach is to use a class decorator, like this:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Class decorator to apply constraints</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_attributes</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorate</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(value, Descriptor):</span><br><span class="line">                value.name = key</span><br><span class="line">                setattr(cls, key, value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                setattr(cls, key, value(key))</span><br><span class="line">        <span class="keyword">return</span> cls</span><br><span class="line">    <span class="keyword">return</span> decorate</span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="meta">@check_attributes(name=SizedString(size=8), shares=UnsignedInteger, price=UnsignedFloat)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, shares, price)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.shares = shares</span><br><span class="line">        self.price = price</span><br></pre></td></tr></table></figure></p>
<p>Another approach to simplify the specification of constraints is to use a metaclass. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A metaclass that applies checking</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">checkedmeta</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, clsname, bases, methods)</span>:</span></span><br><span class="line">        <span class="comment"># Attach attribute names to the descriptors</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> methods.items():</span><br><span class="line">            <span class="keyword">if</span> isinstance(value, Descriptor):</span><br><span class="line">                value.name = key</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, clsname, bases, methods)</span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span><span class="params">(metaclass=checkedmeta)</span>:</span></span><br><span class="line">    name = SizedString(size=<span class="number">8</span>)</span><br><span class="line">    shares = UnsignedInteger()</span><br><span class="line">    price = UnsignedFloat()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, shares, price)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.shares = shares</span><br><span class="line">        self.price = price</span><br></pre></td></tr></table></figure>
<p>First, in the Descriptor base class, you will notice that there is a <strong>__set__()</strong> method, but no corresponding <strong>__get__()</strong>. If a descriptor will do nothing more than extract an identically named value from the underlying instance dictionary, defining <strong>__get__()</strong> is unnecessary. In fact, defining <strong>__get__()</strong> will just make it run slower. Thus, this recipe only focuses on the implementation of <strong>__set__()</strong>.</p>
<p>The overall design of the various descriptor classes is based on mixin classes. For example, the <strong>Unsigned</strong> and <strong>MaxSized</strong> classes are meant to be mixed with the other descriptor classes derived from <strong>Typed</strong>. To handle a specific kind of data type, multiple inheritance is used to combine the desired functionality.</p>
<p>The definitions of the various type classes such as <strong>Integer</strong>, <strong>Float</strong>, and <strong>String</strong> illustrate a useful technique of using class variables to customize an implementation. The <strong>Typed</strong> descriptor merely looks for an <strong>expected_type</strong> attribute that is provided by each of those subclasses.</p>
<p>As a final twist, a class decorator approach can also be used as a replacement for mixin classes, multiple inheritance, and tricky use of the <strong>super()</strong> function. Here is an alternative formulation of this recipe that uses class decorators:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Base class. Uses a descriptor to set a value</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Descriptor</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, **opts)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> opts.items():</span><br><span class="line">            setattr(self, key, value)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line"><span class="comment"># Decorator for applying type checking</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Typed</span><span class="params">(expected_type, cls=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> cls <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">lambda</span> cls: Typed(expected_type, cls)</span><br><span class="line">    super_set = cls.__set__</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, expected_type):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'expected '</span> + str(expected_type))</span><br><span class="line">        super_set(self, instance, value)</span><br><span class="line">    cls.__set__ = __set__</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="comment"># Decorator for unsigned values</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Unsigned</span><span class="params">(cls)</span>:</span></span><br><span class="line">    super_set = cls.__set__</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Expected &gt;= 0'</span>)</span><br><span class="line">        super_set(self, instance, value)</span><br><span class="line">    cls.__set__ = __set__</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="comment"># Decorator for allowing sized values</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MaxSized</span><span class="params">(cls)</span>:</span></span><br><span class="line">    super_init = cls.__init__</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=None, **opts)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'size'</span> <span class="keyword">not</span> <span class="keyword">in</span> opts:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'missing size option'</span>)</span><br><span class="line">        super_init(self, name, **opts)</span><br><span class="line">    cls.__init__ = __init__</span><br><span class="line">    super_set = cls.__set__</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(value) &gt;= self.size:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'size must be &lt; '</span> + str(self.size))</span><br><span class="line">        super_set(self, instance, value)</span><br><span class="line">    cls.__set__ = __set__</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="comment"># Specialized descriptors</span></span><br><span class="line"><span class="meta">@Typed(int)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Integer</span><span class="params">(Descriptor)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">@Unsigned</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsignedInteger</span><span class="params">(Integer)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">@Typed(float)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Float</span><span class="params">(Descriptor)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">@Unsigned</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsignedFloat</span><span class="params">(Float)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">@Typed(str)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span><span class="params">(Descriptor)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">@MaxSized</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SizedString</span><span class="params">(String)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Implementing-Custom-Containers"><a href="#Implementing-Custom-Containers" class="headerlink" title="Implementing Custom Containers"></a>Implementing Custom Containers</h2><p>The collections library defines a variety of abstract base classes that are extremely useful when implementing custom container classes. To illustrate, suppose you want your class to support iteration. To do that, simply start by having it inherit from <strong>collections.Iterable</strong>, as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(collections.Iterable)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>The special feature about inheriting from collections.Iterable is that it ensures you implement all of the required special methods. If you don’t, you’ll get an error upon instantiation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = A()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: Can<span class="string">'t instantiate abstract class A with abstract methods __iter__</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>Other notable classes defined in collections include <strong>Sequence</strong>, <strong>MutableSequence</strong>, <strong>Mapping</strong>, <strong>MutableMapping</strong>, <strong>Set</strong>, and <strong>MutableSet</strong>. Many of these classes form hierarchies with increasing levels of functionality (e.g., one such hierarchy is <strong>Container</strong>, <strong>Iterable</strong>, <strong>Sized</strong>, <strong>Sequence</strong>, and <strong>MutableSequence</strong>). Again, simply instantiate any of these classes to see what methods need to be implemented to make a custom container with that behavior:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> collections</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>collections.Sequence()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: Can<span class="string">'t instantiate abstract class Sequence with abstract methods \</span></span><br><span class="line"><span class="string">__getitem__, __len__</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>Here is a simple example of a class that implements the preceding methods to create a sequence where items are always stored in sorted order.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> bisect</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SortedItems</span><span class="params">(collections.Sequence)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initial= None)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._items= sorted(initial) <span class="keyword">if</span> initial <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> []</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._items[index]</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> len((self._items)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, item)</span>:</span></span><br><span class="line"><span class="meta">... </span>        bisect.insort(self._items, item)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here’s an example of using this class:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = SortedItems([<span class="number">5</span>, <span class="number">1</span>, <span class="number">3</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(items)</span><br><span class="line">[<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items[<span class="number">0</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items[<span class="number">-1</span>]</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items.add(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(items)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items.add(<span class="number">-10</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(items)</span><br><span class="line">[<span class="number">-10</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items[<span class="number">1</span>:<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span> <span class="keyword">in</span> items</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>len(items)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> n <span class="keyword">in</span> items:</span><br><span class="line"><span class="meta">... </span>print(n)</span><br><span class="line">...</span><br><span class="line"><span class="number">-10</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>Inheriting from one of the abstract base classes in collections ensures that your custom container implements all of the required methods expected of the container. However, this inheritance also facilitates type checking.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = SortedItems()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> collections</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(items, collections.Iterable)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(items, collections.Sequence)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(items, collections.Container)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(items, collections.Sized)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(items, collections.Mapping)</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>Many of the abstract base classes in <strong>collections</strong> also provide default implementations of common container methods. To illustrate, suppose you have a class that inherits from <strong>collections.MutableSequence</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Items</span><span class="params">(collections.MutableSequence)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initial= None)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._items= list(initial) <span class="keyword">if</span> initial <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> []</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Gettinh:'</span>, index)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._items[index]</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Setting:'</span>, index, value)</span><br><span class="line"><span class="meta">... </span>        self._items[index]= value</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Deleting:'</span>, index)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">del</span> self._items[index]</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Inserting:'</span>, index, value)</span><br><span class="line"><span class="meta">... </span>        self._items.insert(index, value)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Len'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> len(self._items)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>If you create an instance of Items, you’ll find that it supports almost all of the core list methods (e.g., <strong>append()</strong>, <strong>remove()</strong>, <strong>count()</strong>, etc.).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Items([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>len(a)</span><br><span class="line">Len</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">4</span>)</span><br><span class="line">Len</span><br><span class="line">Inserting: <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">2</span>)</span><br><span class="line">Len</span><br><span class="line">Inserting: <span class="number">4</span> <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.count(<span class="number">2</span>)</span><br><span class="line">Getting: <span class="number">0</span></span><br><span class="line">Getting: <span class="number">1</span></span><br><span class="line">Getting: <span class="number">2</span></span><br><span class="line">Getting: <span class="number">3</span></span><br><span class="line">Getting: <span class="number">4</span></span><br><span class="line">Getting: <span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.remove(<span class="number">3</span>)</span><br><span class="line">Getting: <span class="number">0</span></span><br><span class="line">Getting: <span class="number">1</span></span><br><span class="line">Getting: <span class="number">2</span></span><br><span class="line">Deleting: <span class="number">2</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Delegating-Attribute-Access"><a href="#Delegating-Attribute-Access" class="headerlink" title="Delegating Attribute Access"></a>Delegating Attribute Access</h2><p>Simply stated, delegation is a programming pattern where the responsibility for implementing a particular operation is handed off (i.e., delegated) to a different object. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._a = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># Delegate to the internal self._a instance</span></span><br><span class="line">        <span class="keyword">return</span> self._a.spam(x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Delegate to the internal self._a instance</span></span><br><span class="line">        <span class="keyword">return</span> self._a.foo()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>However, if there are many methods to delegate, an alternative approach is to define the <strong>__getattr__()</strong> method, like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._a = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># Expose all of the methods defined on class A</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._a, name)</span><br></pre></td></tr></table></figure>
<p>Another example of delegation is in the implementation of proxies.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># A proxy class that wraps around another object, but</span></span><br><span class="line"><span class="comment"># exposes its public attributes</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Proxy</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        self._obj = obj</span><br><span class="line">    <span class="comment"># Delegate attribute lookup to internal obj</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        print(<span class="string">'getattr:'</span>, name)</span><br><span class="line">        <span class="keyword">return</span> getattr(self._obj, name)</span><br><span class="line">    <span class="comment"># Delegate attribute assignment</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            super().__setattr__(name, value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'setattr:'</span>, name, value)</span><br><span class="line">            setattr(self._obj, name, value)</span><br><span class="line">    <span class="comment"># Delegate attribute deletion</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            super().__delattr__(name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'delattr:'</span>, name)</span><br><span class="line">            delattr(self._obj, name)</span><br></pre></td></tr></table></figure></p>
<p>Delegation is sometimes used as an alternative to inheritance.  For example, instead of writing code like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>, x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.foo'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'B.spam'</span>)</span><br><span class="line">        super().spam(x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.bar'</span>)</span><br></pre></td></tr></table></figure>
<p>A solution involving delegation would be written as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>, x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.foo'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._a = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'B.spam'</span>, x)</span><br><span class="line">        self._a.spam(x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.bar'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._a, name)</span><br></pre></td></tr></table></figure>
<p>It is also important to emphasize that the <strong>__getattr__()</strong> method usually does not apply to most special methods that start and end with double underscores. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListLike</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._items = []</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._items, name)</span><br></pre></td></tr></table></figure>
<p>If you try to make a <strong>ListLike</strong> object, you’ll find that it supports the common list methods, such as <strong>append(</strong>) and <strong>insert()</strong>. However, it does not support any of the operators like <strong>len()</strong>, item lookup, and so forth.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = ListLike()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.insert(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.sort()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>len(a)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: object of type <span class="string">'ListLike'</span> has no len()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">0</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">'ListLike'</span> object does <span class="keyword">not</span> support indexing</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>To support the different operators, you have to manually delegate the associated special methods yourself.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListLike</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._items = []</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._items, name)</span><br><span class="line">    <span class="comment"># Added special methods to support certain list operations</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self._items)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._items[index]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        self._items[index] = value</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self._items[index]</span><br></pre></td></tr></table></figure></p>
<h2 id="Defining-More-Than-One-Constructor-in-a-Class"><a href="#Defining-More-Than-One-Constructor-in-a-Class" class="headerlink" title="Defining More Than One Constructor in a Class"></a>Defining More Than One Constructor in a Class</h2><p>To define a class with more than one constructor, you should use a class method.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> time</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.year= year</span><br><span class="line"><span class="meta">... </span>        self.month= month</span><br><span class="line"><span class="meta">... </span>        self.day= day</span><br><span class="line"><span class="meta">... </span>    @classmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">today</span><span class="params">(cls)</span>:</span></span><br><span class="line"><span class="meta">... </span>        t= time.localtime()</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> cls(t.tm_year, t.tm_mon, t.tm_mday)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a= Date(<span class="number">2012</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b=Date.today()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">&lt;__main__.Date object at <span class="number">0x05786D90</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.year</span><br><span class="line"><span class="number">2018</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Instead of defining a separate class method, you might be inclined to implement the <strong>__init__()</strong> method in a way that allows for different calling conventions. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(args) == <span class="number">0</span>:</span><br><span class="line">            t = time.localtime()</span><br><span class="line">            args = (t.tm_year, t.tm_mon, t.tm_mday)</span><br><span class="line">        self.year, self.month, self.day = args</span><br></pre></td></tr></table></figure>
<p>Although this technique works in certain cases, it often leads to code that is hard to understand and difficult to maintain. For example, this implementation won’t show useful help strings (with argument names). In addition, code that creates <strong>Date</strong> instances will be less clear. Compare and contrast the following:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = Date(<span class="number">2012</span>, <span class="number">12</span>, <span class="number">21</span>) <span class="comment"># Clear. A specific date.</span></span><br><span class="line">b = Date() <span class="comment"># ??? What does this do?</span></span><br><span class="line"><span class="comment"># Class method version</span></span><br><span class="line">c = Date.today() <span class="comment"># Clear. Today's date.</span></span><br></pre></td></tr></table></figure>
<h2 id="Creating-an-Instance-Without-Invoking-init"><a href="#Creating-an-Instance-Without-Invoking-init" class="headerlink" title="Creating an Instance Without Invoking init"></a>Creating an Instance Without Invoking init</h2><p>A bare uninitialized instance can be created by directly calling the <strong>__new__()</strong> method of a class. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.year= year</span><br><span class="line"><span class="meta">... </span>        self.month= month</span><br><span class="line"><span class="meta">... </span>        self.day= day</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d= Date.__new__(Date)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&lt;__main__.Date object at <span class="number">0x05786E10</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.year</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'Date'</span> object has no attribute <span class="string">'year'</span></span><br></pre></td></tr></table></figure>
<p>As you can see, the resulting instance is uninitialized. Thus, it is now your responsibility to set the appropriate instance variables. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = &#123;<span class="string">'year'</span>:<span class="number">2012</span>, <span class="string">'month'</span>:<span class="number">8</span>, <span class="string">'day'</span>:<span class="number">29</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line"><span class="meta">... </span>setattr(d, key, value)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.year</span><br><span class="line"><span class="number">2012</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.month</span><br><span class="line"><span class="number">8</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Extending-Classes-with-Mixins"><a href="#Extending-Classes-with-Mixins" class="headerlink" title="Extending Classes with Mixins"></a>Extending Classes with Mixins</h2><p>To illustrate, suppose you have an interest in adding various customizations (e.g., logging, set-once, type checking, etc.) to mapping objects. Here are a set of mixin classes that do that:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">LoggedMappingMixin</span>:</span></span><br><span class="line"><span class="meta">... </span>    __slots__= ()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Getting'</span>, str(key))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().__getitem__(key)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Setting &#123;&#125;= &#123;!r&#125;'</span>.format(key, value))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().__setitem__(key, value)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Deleting'</span>, str(key))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().__delitem__(key)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SetOnceMappingMixin</span>:</span></span><br><span class="line"><span class="meta">... </span>    __slots__= ()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> key <span class="keyword">in</span> self:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> KeyError(str(key) + <span class="string">' already set'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().__setitem__(key, value)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">StringKeysMappingMixin</span>:</span></span><br><span class="line"><span class="meta">... </span>    __slots__= ()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(key, str):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'keys must be strings'</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> super().__setitem__(key, value)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>These classes, by themselves, are useless. In fact, if you instantiate any one of them, it does nothing useful at all (other than generate exceptions). Instead, they are supposed to be mixed with other mapping classes through multiple inheritance.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">loggedDict</span><span class="params">(LoggedMappingMixin, dict)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d= loggedDict()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>] = <span class="number">23</span></span><br><span class="line">Setting x= <span class="number">23</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d=SetOnceDefaultDict(list)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>]</span><br><span class="line">[]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>]= <span class="number">23</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">5</span>, <span class="keyword">in</span> __setitem__</span><br><span class="line">KeyError: <span class="string">'x already set'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>].append(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>].append(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">StringOrderedDict</span><span class="params">(StringKeysMappingMixin, SetOnceMappingMixin, OrderedDict)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = StringOrderedDict()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="string">'x'</span>] = <span class="number">23</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="number">42</span>] = <span class="number">10</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"mixin.py"</span>, line <span class="number">45</span>, <span class="keyword">in</span> __setitem__</span><br><span class="line"> <span class="string">'''</span></span><br><span class="line"><span class="string">TypeError: keys must be strings</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>d['x'] = 42</span></span><br><span class="line"><span class="string">Traceback (most recent call last):</span></span><br><span class="line"><span class="string"> File "&lt;stdin&gt;", line 1, in &lt;module&gt;</span></span><br><span class="line"><span class="string"> File "mixin.py", line 46, in __setitem__</span></span><br><span class="line"><span class="string"> __slots__ = ()</span></span><br><span class="line"><span class="string"> File "mixin.py", line 24, in __setitem__</span></span><br><span class="line"><span class="string"> if key in self:</span></span><br><span class="line"><span class="string">KeyError: 'x already set'</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>Mixin classes appear in various places in the standard library, mostly as a means for extending the functionality of other classes similar to as shown. They are also one of the main uses of multiple inheritance. For instance, if you are writing network code, you can often use the <strong>ThreadingMixIn</strong> from the <strong>socketserver</strong> module to add thread support to other network-related classes. For example, here is a multithreaded XMLRPCserver:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlrpc.server <span class="keyword">import</span> SimpleXMLRPCServer</span><br><span class="line"><span class="keyword">from</span> socketserver <span class="keyword">import</span> ThreadingMixIn</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadedXMLRPCServer</span><span class="params">(ThreadingMixIn, SimpleXMLRPCServer)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>The ThreadingMixIn from the socketserver library has to be mixed with an appropriate server class—it can’t be used all by itself.</p>
<p>mixin classes typically have no state of their own. This means there is no <strong>__init__()</strong> method and no instance variables. In this recipe, the specification of <strong>__slots__ = ()</strong> is meant to serve as a strong hint that the mixin classes do not have their own instance data.</p>
<p>If you are thinking about defining a mixin class that has an <strong>__init__()</strong> method and instance variables, be aware that there is significant peril associated with the fact that the class doesn’t know anything about the other classes it’s going to be mixed with. Thus, any instance variables created would have to be named in a way that avoids name clashes. In addition, the <strong>__init__()</strong> method would have to be programmed in a way that properly invokes the <strong>__init__()</strong> method of other classes that are mixed in. In general, thisis difficult to implement since you know nothing about the argument signatures of the other classes. At the very least, you would have to implement something very general using *arg, <strong>kwargs. If the </strong>__init__()<strong> of the mixin class took any arguments of its own, those arguments should be specified by keyword only and named in such a way to avoid name collisions with other arguments. Here is one possible implementation of a mixin defining an </strong><strong>init</strong>()** and accepting a keyword argument:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">RestrictKeysMixin</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, _restrict_key_type, **kwargs)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.__restrict_key_type= _restrict_key_type</span><br><span class="line"><span class="meta">... </span>        super().__init__(*args, **kwargs)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(key, self.__restrict_key_type):</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'Keys must be'</span>, str(self.__restrict_key_type))</span><br><span class="line"><span class="meta">... </span>        super().__setitem__(key, value)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">RDict</span><span class="params">(RestrictKeysMixin, dict)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d= RDict(_restrict_key_type= str)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d= RDict([(<span class="string">'name'</span>,<span class="string">'Dave'</span>), (<span class="string">'n'</span>, <span class="number">37</span>)], _restrict_key_type= str)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f= RDict(_restrict_key_type= str, name= <span class="string">'Dave'</span>, n= <span class="number">37</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Dave'</span>, <span class="string">'n'</span>: <span class="number">37</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f[<span class="number">34</span>]=<span class="number">5</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">7</span>, <span class="keyword">in</span> __setitem__</span><br><span class="line">TypeError: (<span class="string">'Keys must be'</span>, <span class="string">"&lt;class 'str'&gt;"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f[<span class="string">'m'</span>]=<span class="number">90</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'Dave'</span>, <span class="string">'m'</span>: <span class="number">90</span>, <span class="string">'n'</span>: <span class="number">37</span>&#125;</span><br></pre></td></tr></table></figure>
<p>In this example, you’ll notice that initializing an <strong>RDict()</strong> still takes the arguments understood by <strong>dict()</strong>. However, there is an extra keyword argument <strong>restrict_key_type</strong> that is provided to the mixin class.</p>
<p>Use of the super() function is an essential and critical part of writing mixin classes. In the solution, the classes redefine certain critical methods, such as <strong>__getitem__()</strong> and <strong>__setitem__()</strong>. However, they also need to call the original implementation of those methods. Using <strong>super()</strong> delegates to the next class on the method resolution order (MRO). This aspect of the recipe, however, is not obvious to novices, because <strong>super()</strong> is being used in classes that have no parent (at first glance, it might look like an error). However, in a class definition such as this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggedDict</span><span class="params">(LoggedMappingMixin, dict)</span>:</span></span><br><span class="line"> <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>The use of <strong>super()</strong> in <strong>LoggedMappingMixin</strong> delegates to the next class over in the multiple inheritance list. That is, a call such as <strong>super().__getitem__()</strong> in <strong>LoggedMappingMixin</strong> actually steps over and invokes <strong>dict.__getitem__()</strong>. Without this behavior, the mixin class wouldn’t work at all.</p>
<p>An alternative implementation of mixins involves the use of class decorators. For example, consider this code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">LoggedMapping</span><span class="params">(cls)</span>:</span></span><br><span class="line"><span class="meta">... </span>    cls_getitem= cls.__getitem__</span><br><span class="line"><span class="meta">... </span>    cls_setitem= cls.__setitem__</span><br><span class="line"><span class="meta">... </span>    cls_delitem= cls.__delitem__</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Getting'</span>, str(key))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> cls_getitem(self, key)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, item)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Setting &#123;&#125;= &#123;!r&#125;'</span>.format(key, value))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> cls_setitem(self, key, value)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Deleting'</span>, str(key))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> cls_delitem(self, key)</span><br><span class="line"><span class="meta">... </span>    cls.__getitem__= __getitem__</span><br><span class="line"><span class="meta">... </span>    cls.__setitem__= __setitem__</span><br><span class="line"><span class="meta">... </span>    cls.__delitem__= __delitem__</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> cls</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@LoggedMapping</span><br><span class="line"><span class="meta">... </span><span class="class"><span class="keyword">class</span> <span class="title">LoggedDict</span><span class="params">(dict)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Implementing-Stateful-Objects-or-State-Machines"><a href="#Implementing-Stateful-Objects-or-State-Machines" class="headerlink" title="Implementing Stateful Objects or State Machines"></a>Implementing Stateful Objects or State Machines</h2><p>In certain applications, you might have objects that operate differently according to some kind of internal state. For example, consider a simple class representing a connection:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.state = <span class="string">'CLOSED'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state != <span class="string">'OPEN'</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">        print(<span class="string">'reading'</span>)</span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.state != <span class="string">'OPEN'</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">    print(<span class="string">'writing'</span>)</span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.state == <span class="string">'OPEN'</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already open'</span>)</span><br><span class="line">        self.state = <span class="string">'OPEN'</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.state == <span class="string">'CLOSED'</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already closed'</span>)</span><br><span class="line">    self.state = <span class="string">'CLOSED'</span></span><br></pre></td></tr></table></figure>
<p>A more elegant approach is to encode each operational state as a separate class and arrange for the <strong>Connection</strong> class to delegate to the state class. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Connection</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.new_state(ClosedConnectionState)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">new_state</span><span class="params">(self,newstate)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._state= newstate</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._state.read(self)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._state.write(self, data)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._state.open(self)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self._state.close(self)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">ConnectionState</span>:</span></span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">ClosedConnectionState</span><span class="params">(ConnectionState)</span>:</span></span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        conn.new_state(OpenConnectionState)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already closed'</span>)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">OpenConnectionState</span><span class="params">(ConnectionState)</span>:</span></span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'reading'</span>)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'writing'</span>)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already open'</span>)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line"><span class="meta">... </span>        conn.new_state(ClosedConnectionState)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here is an interactive session that illustrates the use of these classes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Connection()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c._state</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">ClosedConnectionState</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="class"><span class="title">Traceback</span> <span class="params">(most recent call last)</span>:</span></span><br><span class="line"> File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">10</span>, <span class="keyword">in</span> read</span><br><span class="line"> <span class="keyword">return</span> self._state.read(self)</span><br><span class="line"> File <span class="string">"example.py"</span>, line <span class="number">43</span>, <span class="keyword">in</span> read</span><br><span class="line"> <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">RuntimeError: Not open</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.open()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c._state</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">OpenConnectionState</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="class"><span class="title">reading</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">write</span><span class="params">(<span class="string">'hello'</span>)</span></span></span><br><span class="line"><span class="class"><span class="title">writing</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">_state</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">ClosedConnectionState</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>It might look a little weird, but each state is implemented by a class with static methods, each of which take an instance of <strong>Connection</strong> as the first argument. This design is based on a decision to not store any instance data in the different state classes themselves. Instead, all instance data should be stored on the <strong>Connection</strong> instance.</p>
<p>An alternative implementation technique concerns direct manipulation of the <strong>__class__</strong> attribute of instances.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.new_state(ClosedConnection)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_state</span><span class="params">(self, newstate)</span>:</span></span><br><span class="line">        self.__class__ = newstate</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosedConnection</span><span class="params">(Connection)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.new_state(OpenConnection)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already closed'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenConnection</span><span class="params">(Connection)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'reading'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        print(<span class="string">'writing'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already open'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.new_state(ClosedConnection)</span><br></pre></td></tr></table></figure>
<p>Finally, either technique is useful in implementing more complicated state machines— especially in code that might otherwise feature large <strong>if-elif-else</strong> blocks. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original implementation</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">State</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.state = <span class="string">'A'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> state == <span class="string">'A'</span>:</span><br><span class="line">            <span class="comment"># Action for A</span></span><br><span class="line">            ...</span><br><span class="line">            state = <span class="string">'B'</span></span><br><span class="line">        <span class="keyword">elif</span> state == <span class="string">'B'</span>:</span><br><span class="line">            <span class="comment"># Action for B</span></span><br><span class="line">                ...</span><br><span class="line">            state = <span class="string">'C'</span></span><br><span class="line">        <span class="keyword">elif</span> state == <span class="string">'C'</span>:</span><br><span class="line">            <span class="comment"># Action for C</span></span><br><span class="line">             ...</span><br><span class="line">            state = <span class="string">'A'</span></span><br><span class="line"><span class="comment"># Alternative implementation</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">State</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.new_state(State_A)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_state</span><span class="params">(self, state)</span>:</span></span><br><span class="line">        self.__class__ = state</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">State_A</span><span class="params">(State)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># Action for A</span></span><br><span class="line">        ...</span><br><span class="line">        self.new_state(State_B)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">State_B</span><span class="params">(State)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># Action for B</span></span><br><span class="line">        ...</span><br><span class="line">        self.new_state(State_C)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">State_C</span><span class="params">(State)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># Action for C</span></span><br><span class="line">        ...</span><br><span class="line">        self.new_state(State_A)</span><br></pre></td></tr></table></figure>
<h2 id="Calling-a-Method-on-an-Object-Given-the-Name-As-a-String"><a href="#Calling-a-Method-on-an-Object-Given-the-Name-As-a-String" class="headerlink" title="Calling a Method on an Object Given the Name As a String"></a>Calling a Method on an Object Given the Name As a String</h2><p>You have the name of a method that you want to call on an object stored in a string and you want to execute the method. For simple cases, you might use <strong>getattr()</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.x= x</span><br><span class="line"><span class="meta">... </span>        self.y =y</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="string">'Point(&#123;!r:&#125;, &#123;!r:&#125;)'</span>.format(self.x, self.y)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">distance</span><span class="params">(self, x,y)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> math.hypot(self.x-x, self.y- y)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p= Point(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d= getattr(p, <span class="string">'distance'</span>)(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line"><span class="number">3.6055512754639896</span></span><br></pre></td></tr></table></figure>
<p>An alternative approach is to use <strong>operator.methodcaller().</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> operator</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>operator.methodcaller(<span class="string">'distance'</span>, <span class="number">0</span>,<span class="number">0</span> )(p)</span><br><span class="line"><span class="number">3.6055512754639896</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>points = [</span><br><span class="line"><span class="meta">... </span> Point(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line"><span class="meta">... </span> Point(<span class="number">3</span>, <span class="number">0</span>),</span><br><span class="line"><span class="meta">... </span> Point(<span class="number">10</span>, <span class="number">-3</span>),</span><br><span class="line"><span class="meta">... </span> Point(<span class="number">-5</span>, <span class="number">-7</span>),</span><br><span class="line"><span class="meta">... </span> Point(<span class="number">-1</span>, <span class="number">8</span>),</span><br><span class="line"><span class="meta">... </span> Point(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"><span class="meta">... </span>]</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>points.sort(key= operator.methodcaller(<span class="string">'distance'</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>points</span><br><span class="line">[Point(<span class="number">1</span>, <span class="number">2</span>), Point(<span class="number">3</span>, <span class="number">0</span>), Point(<span class="number">3</span>, <span class="number">2</span>), Point(<span class="number">-1</span>, <span class="number">8</span>), Point(<span class="number">-5</span>, <span class="number">-7</span>), Point(<span class="number">10</span>, <span class="number">-3</span>)]</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>Calling a method is actually two separate steps involving an attribute lookup and a function call. Therefore, to call a method, you simply look up the attribute using getattr(), as for any other attribute. To invoke the result as a method, simply treat the result of the lookup as a function.</p>
<p><strong>operator.methodcaller(</strong>) creates a callable object, but also fixes any arguments that are going to be supplied to the method. All that you need to do is provide the appropriate <strong>self</strong> argument. </p>
<h2 id="Implementing-the-Visitor-Pattern"><a href="#Implementing-the-Visitor-Pattern" class="headerlink" title="Implementing the Visitor Pattern"></a>Implementing the Visitor Pattern</h2><p>You need to write code that processes or navigates through a complicated data structure consisting of many different kinds of objects, each of which needs to be handled in a different way. For example, walking through a tree structure and performing different actions depending on what kind of tree nodes are encountered.</p>
<p>The problem addressed by this recipe is one that often arises in programs that build data structures consisting of a large number of different kinds of objects. To illustrate, suppose you are trying to write a program that represents mathematical expressions. To do that, the program might employ a number of classes, like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">UnaryOperator</span><span class="params">(Node)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, operand)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.operand= operand</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">BinaryOperator</span><span class="params">(Node)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, left, right)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.left= left</span><br><span class="line"><span class="meta">... </span>        self.right= right</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Add</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Sub</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Mul</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Div</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Negate</span><span class="params">(UnaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Number</span><span class="params">(Node)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.value= value</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>These classes would then be used to build up nested data structures, like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Representation of 1 + 2 * (3 - 4) / 5</span></span><br><span class="line">t1 = Sub(Number(<span class="number">3</span>), Number(<span class="number">4</span>))</span><br><span class="line">t2 = Mul(Number(<span class="number">2</span>), t1)</span><br><span class="line">t3 = Div(t2, Number(<span class="number">5</span>))</span><br><span class="line">t4 = Add(Number(<span class="number">1</span>), t3)</span><br></pre></td></tr></table></figure>
<p>For example, given such an expression, a program might want to do any number of things (e.g., produce output, generate instructions, perform translation, etc.).</p>
<p>To enable general-purpose processing, a common solution is to implement the so-called “visitor pattern” using a class similar to this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">NodeVisitor</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        methname= <span class="string">'visit_'</span>+ type(node).__name__</span><br><span class="line"><span class="meta">... </span>        meth= getattr(self, methname, <span class="keyword">None</span>)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> meth <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line"><span class="meta">... </span>            meth= self.generic_visit</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> meth(node)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">generic_visit</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> RuntimeError(<span class="string">'No &#123;&#125; method'</span>.format(<span class="string">'visit_'</span>+ type(node).__name__))</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>To use this class, a programmer inherits from it and implements various methods of the form <strong>visit_Name()</strong>, where <strong>Name</strong> is substituted with the node type. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Evaluator</span><span class="params">(NodeVisitor)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Number</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> node.value</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Add</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.visit(node.left) + self.visit(node.right)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Sub</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.visit(node.left)- self.visit(node.right)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Mul</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.visit(node.left)* self.visit(node.right)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Div</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.visit(node.left)/ self.visit(node.right)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Negate</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> -node.operand</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here is an example of how you would use this class using the previously generated expression:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = Evaluator()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.visit(t4)</span><br><span class="line"><span class="number">0.6</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>As a completely different example, here is a class that translates an expression into operations on a simple stack machine:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">StackCode</span><span class="params">(NodeVisitor)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">generate_code</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.instructions= []</span><br><span class="line"><span class="meta">... </span>        self.visit(node)</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.instructions</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Number</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.instructions.append((<span class="string">'PUSH'</span>, node.value))</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">binop</span><span class="params">(self, node, instruction)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.visit(node.left)</span><br><span class="line"><span class="meta">... </span>        self.visit(node.right)</span><br><span class="line"><span class="meta">... </span>        self.instructions.append((instruction,))</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Add</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.binop(node,<span class="string">'Add'</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Sub</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.binop(node, <span class="string">'SUB'</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Mul</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.binop(node, <span class="string">'MUL'</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Div</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.binop(self, <span class="string">'DIV'</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">unaryop</span><span class="params">(self, node, instruction)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.visit(node.operand)</span><br><span class="line"><span class="meta">... </span>        self.instrctions.append((instruction,))</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">visit_Negate</span><span class="params">(self, node)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.unaryop(node, <span class="string">'NEG'</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here is an example of this class in action:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = StackCode()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.generate_code(t4)</span><br><span class="line">[(<span class="string">'PUSH'</span>, <span class="number">1</span>), (<span class="string">'PUSH'</span>, <span class="number">2</span>), (<span class="string">'PUSH'</span>, <span class="number">3</span>), (<span class="string">'PUSH'</span>, <span class="number">4</span>), (<span class="string">'SUB'</span>,),</span><br><span class="line"> (<span class="string">'MUL'</span>,), (<span class="string">'PUSH'</span>, <span class="number">5</span>), (<span class="string">'DIV'</span>,), (<span class="string">'ADD'</span>,)]</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>There are really two key ideas in this recipe. The first is a design strategy where code that manipulates a complicated data structure is decoupled from the data structure itself. That is, in this recipe, none of the various Node classes provide any implementation that does anything with the data. Instead, all of the data manipulation is carried out by specific implementations of the separate <strong>NodeVisitor</strong> class. This separation makes the code extremely general purpose.</p>
<p>The second major idea of this recipe is in the implementation of the visitor class itself. In the visitor, you want to dispatch to a different handling method based on some value such as the node type. In a naive implementation, you might be inclined to write a huge <strong>if</strong> statement, like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeVisitor</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        nodetype = type(node).__name__</span><br><span class="line">        <span class="keyword">if</span> nodetype == <span class="string">'Number'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.visit_Number(node)</span><br><span class="line">        <span class="keyword">elif</span> nodetype == <span class="string">'Add'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.visit_Add(node)</span><br><span class="line">        <span class="keyword">elif</span> nodetype == <span class="string">'Sub'</span>:</span><br><span class="line">            <span class="keyword">return</span> self.visit_Sub(node)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>It’s much better to play a little trick where you form the name of a method and go fetch it with the <strong>getattr()</strong> function, as shown. The <strong>generic_visit()</strong> method in the solution is a fallback should no matching handler method be found. In this recipe, it raises an exception to alert the programmer that an unexpected node type was encountered.</p>
<p>Within each visitor class, it is common for calculations to be driven by recursive calls to the <strong>visit()</strong> method. For example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evaluator</span><span class="params">(NodeVisitor)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Add</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.visit(node.left) + self.visit(node.right)</span><br></pre></td></tr></table></figure>
<h2 id="Implementing-the-Visitor-Pattern-Without-Recursion"><a href="#Implementing-the-Visitor-Pattern-Without-Recursion" class="headerlink" title="Implementing the Visitor Pattern Without Recursion"></a>Implementing the Visitor Pattern Without Recursion</h2><p>You’re writing code that navigates through a deeply nested tree structure using the visitor pattern, but it blows up due to exceeding the recursion limit. You’d like to eliminate the recursion, but keep the programming style of the visitor pattern.</p>
<p>Clever use of generators can sometimes be used to eliminate recursion from algorithms involving tree traversal or searching. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeVisitor</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        stack= [node]</span><br><span class="line">        last_result= <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">while</span> stack:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                last= stack[<span class="number">-1</span>]</span><br><span class="line">                <span class="keyword">if</span> isinstance(last, types.GeneratorType):</span><br><span class="line">                    stack.append(last.send(last_result))</span><br><span class="line">                    last_result= <span class="keyword">None</span></span><br><span class="line">                <span class="keyword">elif</span> isinstance(last, Node):</span><br><span class="line">                    stack.append(self._visit(stack.pop()))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    last_result= stack.pop()</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                stack.pop()</span><br><span class="line">        <span class="keyword">return</span> last_result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_visit</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        methname= <span class="string">'visit_'</span> + type(node).__name__</span><br><span class="line">        meth=getattr(self, methname, <span class="keyword">None</span>)</span><br><span class="line">        <span class="keyword">if</span> meth <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            meth= self.generic_visit</span><br><span class="line">        <span class="keyword">return</span> meth(node)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generic_visit</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'No &#123;&#125; method'</span>.format(<span class="string">'visit_'</span>+ type(node).__name__))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnaryOperator</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, operand)</span>:</span></span><br><span class="line">        self.operand= operand</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryOperator</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, left, right)</span>:</span></span><br><span class="line">        self.left= left</span><br><span class="line">        self.right= right</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Add</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sub</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mul</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Div</span><span class="params">(BinaryOperator)</span>:</span> <span class="keyword">pass</span>    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Negate</span><span class="params">(UnaryOperator)</span>:</span> <span class="keyword">pass</span>    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self.value= value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evaluator</span><span class="params">(NodeVisitor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Number</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> node.value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Add</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.visit(node.left) + self.visit(node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Sub</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.visit(node.left) - self.visit(node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Mul</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.visit(node.left) * self.visit(node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Div</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.visit(node.left) / self.visit(node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Negate</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> - self.visit(node.operand)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    t1= Sub(Number(<span class="number">3</span>), Number(<span class="number">4</span>))</span><br><span class="line">    t2= Mul(Number(<span class="number">2</span>), t1)</span><br><span class="line">    t3= Div(t2, Number(<span class="number">5</span>))</span><br><span class="line">    t4= Add(Number(<span class="number">1</span>), t3)</span><br><span class="line"></span><br><span class="line">    e= Evaluator()</span><br><span class="line">    print(e.visit(t4)) <span class="comment"># Outputs 0.6</span></span><br></pre></td></tr></table></figure>
<p>The preceding code works for simple expressions. However, the implementation of Evaluator uses recursion and crashes if things get too nested. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Number(<span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">100000</span>):</span><br><span class="line"><span class="meta">... </span>a = Add(a, Number(n))</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = Evaluator()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.visit(a)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line"> File <span class="string">"visitor.py"</span>, line <span class="number">29</span>, <span class="keyword">in</span> _visit</span><br><span class="line"> <span class="keyword">return</span> meth(node)</span><br><span class="line"> File <span class="string">"visitor.py"</span>, line <span class="number">67</span>, <span class="keyword">in</span> visit_Add</span><br><span class="line"> <span class="keyword">return</span> self.visit(node.left) + self.visit(node.right)</span><br><span class="line">RuntimeError: maximum recursion depth exceeded</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Now let’s change the Evaluator class ever so slightly to the following:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evaluator</span><span class="params">(NodeVisitor)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Number</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> node.value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Add</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        print(<span class="string">'Add:'</span>, node)</span><br><span class="line">        lhs= <span class="keyword">yield</span> node.left</span><br><span class="line">        print(<span class="string">'left='</span>, lhs)</span><br><span class="line">        rhs= <span class="keyword">yield</span> node.right</span><br><span class="line">        print(<span class="string">'right='</span>, rhs)</span><br><span class="line">        <span class="keyword">yield</span> lhs + rhs</span><br><span class="line">        <span class="comment">#yield (yield node.left) + (yield node.right)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Sub</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> (<span class="keyword">yield</span> node.left) - (<span class="keyword">yield</span> node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Mul</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> (<span class="keyword">yield</span> node.left) * (<span class="keyword">yield</span> node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Div</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> (<span class="keyword">yield</span> node.left) / (<span class="keyword">yield</span> node.right)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visit_Negate</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> - (<span class="keyword">yield</span> node.operand)</span><br></pre></td></tr></table></figure>
<p>If you try the same recursive experiment, you’ll find that it suddenly works.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Number(<span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line"><span class="meta">... </span>a = Add(a, Number(n))</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = Evaluator()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.visit(a)</span><br><span class="line"><span class="number">4999950000</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>First, in problems related to tree traversal, a common implementation strategy for avoiding recursion is to write algorithms involving a stack or queue. For example, depthfirst traversal can be implemented entirely by pushing nodes onto a stack when first encountered and then popping them off once processing has finished. The central core of the <strong>visit()</strong> method in the solution is built around this idea. The algorithm starts by pushing the initial node onto the <strong>stack</strong> list and runs until the stack is empty. During execution, the stack will grow according to the depth of the underlying tree structure.</p>
<p>The second insight concerns the behavior of the <strong>yield</strong> statement in generators. When <strong>yield</strong> is encountered, the behavior of a generator is to emit a value and to suspend. This recipe uses this as a replacement for recursion. For example, instead of writing a recursive expression like this:</p>
<p><code>value = self.visit(node.left)</code></p>
<p>you replace it with the following:</p>
<p><code>value = yield node.left</code></p>
<p>Behind the scenes, this sends the node in question (node.left) back to the <strong>visit()</strong> method. The <strong>visit()</strong> method then carries out the execution of the appropriate <strong>visit_Name()</strong> method for that node. In some sense, this is almost the opposite of recursion. That is, instead of calling <strong>visit()</strong> recursively to move the algorithm forward, the <strong>yield</strong> statement is being used to temporarily back out of the computation in progress. Thus, the <strong>yield</strong> is essentially a signal that tells the algorithm that the yielded node needs to be processed first before further progress can be made.</p>
<p>The final part of this recipe concerns propagation of results. When generator functions are used, you can no longer use return statements to emit values (doing so will cause a SyntaxError exception). Thus, the yield statement has to do double duty to cover the case. In this recipe, if the value produced by a yield statement is a non-Node type, it is assumed to be a value that will be propagated to the next step of the calculation. This is the purpose of the last_return variable in the code. Typically, this would hold the last value yielded by a visit method. That value would then be sent into the previously executing method, where it would show up as the return value from a yield statement. For example, in this code: value = yield node.left The value variable gets the value of last_return, which is the result returned by the visitor method invoked for node.left.</p>
<p>The code works by simply looking at the top of the stack and deciding what to do next. If it’s a generator, then its <strong>send()</strong> method is invoked with the last result (if any) and the result appended onto the stack for further processing. The value returned by <strong>send()</strong> is the same value that was given to the <strong>yield</strong> statement. Thus, in a statement such as <strong>yield node.left</strong>, the <strong>Node</strong> instance <strong>node.left</strong> is returned by <strong>send()</strong> and placed on the top of the stack.</p>
<p>If the top of the stack is a <strong>Node</strong> instance, then it is replaced by the result of calling the appropriate visit method for that node. This is where the underlying recursion is being eliminated. Instead of the various visit methods directly calling <strong>visit()</strong> recursively, it takes place here. As long as the methods use <strong>yield</strong>, it all works out.</p>
<p>Finally, if the top of the stack is anything else, it’s assumed to be a return value of some kind. It just gets popped off the stack and placed into <strong>last_result</strong>. If the next item on the stack is a generator, then it gets sent in as a return value for the <strong>yield</strong>. It should be noted that the final return value of <strong>visit()</strong> is also set to <strong>last_result</strong>. This is what makes this recipe work with a traditional recursive implementation. If no generators are being used, this value simply holds the value given to any return statements used in the code.</p>
<h2 id="Making-Classes-Support-Comparison-Operations"><a href="#Making-Classes-Support-Comparison-Operations" class="headerlink" title="Making Classes Support Comparison Operations"></a>Making Classes Support Comparison Operations</h2><p>Python classes can support comparison by implementing a special method for each comparison operator. For example, to support the <strong>&gt;=</strong> operator, you define a <strong>__ge__()</strong> method in the classes. Although defining a single method is usually no problem, it quickly gets tedious to create implementations of every possible comparison operator.</p>
<p>The <strong>functools.total_ordering</strong> decorator can be used to simplify this process. To use it, you decorate a class with it, and define <strong>__eq__()</strong> and one other comparison method (<strong>__lt__</strong>, <strong>__le__</strong>, <strong>__gt__</strong>, or <strong>__ge__()</strong>). The decorator then fills in the other comparison methods for you.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Room</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, length, width)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line"><span class="meta">... </span>        self.length= length</span><br><span class="line"><span class="meta">... </span>        self.width= width</span><br><span class="line"><span class="meta">... </span>        self.square_feet= self.length * self.width</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@total_ordering</span><br><span class="line"><span class="meta">... </span><span class="class"><span class="keyword">class</span> <span class="title">House</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, style)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line"><span class="meta">... </span>        self.style= style</span><br><span class="line"><span class="meta">... </span>        self.rooms=list()</span><br><span class="line"><span class="meta">... </span>    @property</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">living_space_footage</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> sum(r.square_feet <span class="keyword">for</span> r <span class="keyword">in</span> self.rooms)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">add_room</span><span class="params">(self, room)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.rooms.append(room)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="string">'&#123;&#125;: &#123;&#125; square foot &#123;&#125;'</span>.format(self.name, self.living_space_footage, self.style)</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.living_space_footage== other.living_space_footage</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> self.living_space_footage &lt; other.living_space_footage</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Here, the House class has been decorated with @total_ordering. Definitions of<strong>__eq__()</strong> and <strong>__lt__</strong> are provided to compare houses based on the total square footage of their rooms. This minimum definition is all that is required to make all of the other comparison operations work.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>h1 = House(<span class="string">'h1'</span>, <span class="string">'Cape'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h1.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h1.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h1.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h1.add_room(Room(<span class="string">'Office'</span>, <span class="number">12</span>, <span class="number">12</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h2 = House(<span class="string">'h2'</span>, <span class="string">'Ranch'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h2.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h2.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h2.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h3 = House(<span class="string">'h3'</span>, <span class="string">'Split'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h3.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h3.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h3.add_room(Room(<span class="string">'Office'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h3.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">15</span>, <span class="number">17</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>houses = [h1, h2, h3]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Is h1 bigger than h2?'</span>, h1 &gt; h2)</span><br><span class="line">Is h1 bigger than h2? True</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Is h2 smaller than h3?'</span>, h2 &lt; h3) <span class="comment"># prints True</span></span><br><span class="line">Is h2 smaller than h3? True</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Is h2 greater than or equal to h1?'</span>, h2 &gt;= h1) <span class="comment"># Prints False</span></span><br><span class="line">Is h2 greater than or equal to h1? False</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Which one is biggest?'</span>, max(houses)) <span class="comment"># Prints 'h3: 1101-square-foot Split'</span></span><br><span class="line">Which one is biggest? h3: 1101 square foot Split</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Which is smallest?'</span>, min(houses)) <span class="comment"># Prints 'h2: 846-square-foot Ranch'</span></span><br><span class="line">Which is smallest? h2: 846 square foot Ranch</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>f you’ve written the code to make a class support all of the basic comparison operators, then total_ordering probably doesn’t seem all that magical: it literally defines a mapping from each of the comparison-supporting methods to all of the other ones that would be required. So, if you defined<strong>__lt__</strong> in your class as in the solution, it is used to build all of the other comparison operators. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># Methods created by @total_ordering</span></span><br><span class="line">    __le__ = <span class="keyword">lambda</span> self, other: self &lt; other <span class="keyword">or</span> self == other</span><br><span class="line">    __gt__ = <span class="keyword">lambda</span> self, other: <span class="keyword">not</span> (self &lt; other <span class="keyword">or</span> self == other)</span><br><span class="line">    __ge__ = <span class="keyword">lambda</span> self, other: <span class="keyword">not</span> (self &lt; other)</span><br><span class="line">    __ne__ = <span class="keyword">lambda</span> self, other: <span class="keyword">not</span> self == other</span><br></pre></td></tr></table></figure>
<h2 id="Creating-Cached-Instances"><a href="#Creating-Cached-Instances" class="headerlink" title="Creating Cached Instances"></a>Creating Cached Instances</h2><p>When creating instances of a class, you want to return a cached reference to a previous instance created with the same arguments (if any).  Practical examples include the behavior of libraries, such as the <strong>logging</strong> module, that only want to associate a single logger instance with a given name.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import logging</span><br><span class="line">&gt;&gt;&gt; a = logging.getLogger(&apos;foo&apos;)</span><br><span class="line">&gt;&gt;&gt; b = logging.getLogger(&apos;bar&apos;)</span><br><span class="line">&gt;&gt;&gt; a is b</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; c = logging.getLogger(&apos;foo&apos;)</span><br><span class="line">&gt;&gt;&gt; a is c</span><br><span class="line">True</span><br></pre></td></tr></table></figure>
<p>To implement this behavior, you should make use of a factory function that’s separate from the class itself.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> weakref</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>_spam_cache= weakref.WeakValueDictionary()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> _spam_cache:</span><br><span class="line"><span class="meta">... </span>        s=Spam(name)</span><br><span class="line"><span class="meta">... </span>        _spam_cache[name] = s</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>        s= _spam_cache[name]</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> s    </span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>If you use this implementation, you’ll find that it behaves in the manner shown earlier:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = get_spam(<span class="string">'foo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = get_spam(<span class="string">'bar'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> b</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = get_spam(<span class="string">'foo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> c</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Writing a special factory function is often a simple approach for altering the normal rules of instance creation. One question that often arises at this point is whether or not a more elegant approach could be taken. For example, you might consider a solution that redefines the <strong>__new__()</strong> method of a class as follows:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">... </span>    _spam_cache= weakref.WeakValueDictionary()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> name <span class="keyword">in</span> cls._spam_cache:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> cls._spam_cache[name]</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>            self= super().__new__(cls)</span><br><span class="line"><span class="meta">... </span>            cls._spam_cache[name]= self</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">return</span> self</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Initializing Spam'</span>)</span><br><span class="line"><span class="meta">... </span>        self.name= name</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>However, a major problem is that the <strong>__init__()</strong> method always gets called, regardless of whether the instance was cached or not. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s= Spam(<span class="string">'Dave'</span>)</span><br><span class="line">Initializing Spam</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>t= Spam(<span class="string">'Dave'</span>)</span><br><span class="line">Initializing Spam</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s <span class="keyword">is</span> t</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>That behavior is probably not what you want. So, to solve the problem of caching without reinitialization, you need to take a slightly different approach.</p>
<p>When maintaining a cache of instances, you often only want to keep items in the cache as long as they’re actually being used somewhere in the program. A <strong>WeakValueDictionary</strong> instance only holds onto the referenced items as long as they exist somewhere else. Otherwise, the dictionary keys disappear when instances are no longer being used. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = get_spam(<span class="string">'foo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = get_spam(<span class="string">'bar'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = get_spam(<span class="string">'foo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(_spam_cache)</span><br><span class="line">[<span class="string">'foo'</span>, <span class="string">'bar'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> c</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(_spam_cache)</span><br><span class="line">[<span class="string">'bar'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> b</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(_spam_cache)</span><br><span class="line">[]</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>One immediate concern with this recipe might be its reliance on global variables and a factory function that’s decoupled from the original class definition. One way to clean this up is to put the caching code into a separate manager class and glue things together like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">CachedSpamManager</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._cache= weakref.WeakValueDictionary()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self._cache:</span><br><span class="line"><span class="meta">... </span>            s= Spam(name)</span><br><span class="line"><span class="meta">... </span>            self._cache[name] = s</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>            s= self._cache[name]</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> s</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._cache.clear()</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">... </span>    manager= CachedSpamManager()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self.name=name</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'name:'</span>, name)</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> Spam.manager.get_spam(name)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Another design consideration is whether or not you want to leave the class definition exposed to the user. If you do nothing, a user can easily make instances, bypassing the caching mechanism:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Spam(<span class="string">'foo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Spam(<span class="string">'foo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> b</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>If preventing this is important, you can take certain steps to avoid it. For example, you might give the class a name starting with an underscore, such as <strong>_Spam</strong>, which at least gives the user a clue that they shouldn’t access it directly.</p>
<p>Alternatively, if you want to give users a stronger hint that they shouldn’t instantiate Spam instances directly, you can make <strong>__init__()</strong> raise an exception and use a class method to make an alternate constructor like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> RuntimeError(<span class="string">'Can not instantiate directly'</span>)</span><br><span class="line"><span class="meta">... </span>    @classmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">_new</span><span class="params">(cls, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self= cls.__new__(cls)</span><br><span class="line"><span class="meta">... </span>        self.name = name</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">CachedSpamManager</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._cache= weakref.WeakValueDictionary()</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self._cache:</span><br><span class="line"><span class="meta">... </span>            s= Spam._new(name)</span><br><span class="line"><span class="meta">... </span>            self._cache[name] = s</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>            s= self._cache[name]</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> s</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        self._cache.clear()</span><br><span class="line"><span class="meta">... </span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/15/C07-Functions/" rel="next" title="C07_Functions">
                <i class="fa fa-chevron-left"></i> C07_Functions
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/15/C09-Metaprogramming/" rel="prev" title="C09_Metaprogramming">
                C09_Metaprogramming <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="eustoma" />
            
              <p class="site-author-name" itemprop="name">eustoma</p>
              <p class="site-description motion-element" itemprop="description">Too young to be old, too old to be young</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">114</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/bobingski" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://t.me/naeJean" target="_blank" title="Telegram">
                      
                        <i class="fa fa-fw fa-telegram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://newdoub.com" title="doubi1" target="_blank">doubi1</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://doub.io" title="doubi2" target="_blank">doubi2</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://google1.jiongjun.cc/" title="mirror" target="_blank">mirror</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://program-think.blogspot.com/" title="blogspot" target="_blank">blogspot</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Changing-the-String-Representation-of-Instances"><span class="nav-number">1.</span> <span class="nav-text">Changing the String Representation of Instances</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Customizing-String-Formatting"><span class="nav-number">2.</span> <span class="nav-text">Customizing String Formatting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Making-Objects-Support-the-Context-Management-Protocol"><span class="nav-number">3.</span> <span class="nav-text">Making Objects Support the Context-Management Protocol</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Saving-Memory-When-Creating-a-Large-Number-of-Instances"><span class="nav-number">4.</span> <span class="nav-text">Saving Memory When Creating a Large Number of Instances</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Encapsulating-Names-in-a-Class"><span class="nav-number">5.</span> <span class="nav-text">Encapsulating Names in a Class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-Managed-Attributes"><span class="nav-number">6.</span> <span class="nav-text">Creating Managed Attributes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Calling-a-Method-on-a-Parent-Class"><span class="nav-number">7.</span> <span class="nav-text">Calling a Method on a Parent Class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Extending-a-Property-in-a-Subclass"><span class="nav-number">8.</span> <span class="nav-text">Extending a Property in a Subclass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-a-New-Kind-of-Class-or-Instance-Attribute"><span class="nav-number">9.</span> <span class="nav-text">Creating a New Kind of Class or Instance Attribute</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Using-Lazily-Computed-Properties"><span class="nav-number">10.</span> <span class="nav-text">Using Lazily Computed Properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simplifying-the-Initialization-of-Data-Structures"><span class="nav-number">11.</span> <span class="nav-text">Simplifying the Initialization of Data Structures</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Defining-an-Interface-or-Abstract-Base-Class"><span class="nav-number">12.</span> <span class="nav-text">Defining an Interface or Abstract Base Class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-a-Data-Model-or-Type-System"><span class="nav-number">13.</span> <span class="nav-text">Implementing a Data Model or Type System</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-Custom-Containers"><span class="nav-number">14.</span> <span class="nav-text">Implementing Custom Containers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Delegating-Attribute-Access"><span class="nav-number">15.</span> <span class="nav-text">Delegating Attribute Access</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Defining-More-Than-One-Constructor-in-a-Class"><span class="nav-number">16.</span> <span class="nav-text">Defining More Than One Constructor in a Class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-an-Instance-Without-Invoking-init"><span class="nav-number">17.</span> <span class="nav-text">Creating an Instance Without Invoking init</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Extending-Classes-with-Mixins"><span class="nav-number">18.</span> <span class="nav-text">Extending Classes with Mixins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-Stateful-Objects-or-State-Machines"><span class="nav-number">19.</span> <span class="nav-text">Implementing Stateful Objects or State Machines</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Calling-a-Method-on-an-Object-Given-the-Name-As-a-String"><span class="nav-number">20.</span> <span class="nav-text">Calling a Method on an Object Given the Name As a String</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-the-Visitor-Pattern"><span class="nav-number">21.</span> <span class="nav-text">Implementing the Visitor Pattern</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementing-the-Visitor-Pattern-Without-Recursion"><span class="nav-number">22.</span> <span class="nav-text">Implementing the Visitor Pattern Without Recursion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Making-Classes-Support-Comparison-Operations"><span class="nav-number">23.</span> <span class="nav-text">Making Classes Support Comparison Operations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-Cached-Instances"><span class="nav-number">24.</span> <span class="nav-text">Creating Cached Instances</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">eustoma</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
